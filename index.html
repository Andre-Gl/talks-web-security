<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <title>Web Security</title>

  <link rel="stylesheet" href="reveal.js/css/reset.css">
  <link rel="stylesheet" href="reveal.js/css/reveal.css">
  <link rel="stylesheet" href="reveal.js/css/theme/black.css">
  <!-- style overrides -->
  <link rel="stylesheet" href="css/styles.css">

  <!-- Theme used for syntax highlighting of code -->
  <link rel="stylesheet" href="reveal.js/lib/css/monokai.css">

  <!-- Printing and PDF exports -->
  <script>
    var link = document.createElement('link');
    link.rel = 'stylesheet';
    link.type = 'text/css';
    link.href = window.location.search.match(/print-pdf/gi) ? 'reveal.js/css/print/pdf.css' : 'reveal.js/css/print/paper.css';
    document.getElementsByTagName('head')[0].appendChild(link);
  </script>
</head>

<body>
  <div class="reveal">
    <div class='footer'>
      <img height="64" src="./img/WA-web-logo-no-text.png" alt="WhatsApp Web logo">
    </div>
    <div class="slides">
      <section>
        <h1>Web Security</h1>
        <img height="64" src="./img/WA-web-logo.png" class="icon" alt="WhatsApp Web logo">
      </section>
      <section>
        <h3>About me</h3>
        <p>Andre Gloukhmantchouk</p>
        <p>Front-End Engineer @Facebook WhatsApp Web</p>
      </section>

      <section>
        <h3>Agenda</h3>
        <ul>
          <li>Where'er the threats?</li>
          <li>Cross-Site Scripting (XSS)</li>
          <li>Examples os XSS out there</li>
          <li>Remediation</li>
        </ul>
      </section>
      <section>
        <h3>Where'er the threats?</h3>
      </section>
      <section>
        <img src="./img/sql-inj.jpeg" alt="SQL Injection">
      </section>
      <section>
        <h3>Where'er the threats?</h3>
        <p>We as users want content and services online 24/7.</p>
        <ul>
          <li>Banking</li>
          <li>Health information</li>
          <li>Travel plans and tickets</li>
          <li>Communication with loved ones or business</li>
        </ul>
      </section>

      <section>
        <img src="./img/stats.png" class="icon" alt="Threats State">
        <small><a href="https://www.hackerone.com/sites/default/files/2019-08/hacker-powered-security-report-2019.pdf">HackerOne 2019 Report</a></small>
      </section>
      <section>
        <h3>Cross-Site Scripting (XSS)</h3>
        <ul>
          <li><p>Injecting untrusted scripts into trusted web contents.</p></li>
          <li><p>XSS attacks occur when an attacker uses a web application to send malicious code, generally in the form of a browser side script, to a different end user.</p></li>
          <li><p>Usually caused by insufficient validation, sanitization or escaping of strings from untrusted sources.</p></li>
        </ul>
      </section>
      <section>
        <h3>Why Cross-Site Scripting attacks common?</h3>
        <ul>
          <li>
            <p>XSS is easy to introduce</p>
            <pre><code data-trim class="hljs">
              eval(foo);
              document.createElement('div').innerHTML='&lt;foo&gt;';
              document.createElement('script').src='//foo';
              document.createElement('div').innerHTML='&lt;foo&gt;';
              document.createElement('a').insertAdjacentHTML(
                'beforebegin', '&lt;foo&gt;');
              new DOMParser().createFromString(
                '&lt;foo&gt;', 'text/html');
              window.open('//foo');
            </code></pre>

          </li>
          <li>
            <p>XSS is difficult to detect (by humans or static analysis)</p>
            <pre><code data-trim class="hljs">
              myElement[attr] = definitelyNotMalicious;
            </code></pre>
          </li>
      </section>
      <section>
        <h3>Types of Cross-Site Scripting attacks</h3>
        <ul>
          <li>
            Reflected
            <p>Atacker needs to induce user to make a particular request containing their exploit.</p>
          </li>
          <li>
            Stored (or Persistent)
            <p>The exploit placed into application itself.</p>
          </li>
        </ul>
      </section>
      <section>
        <h3>But we use react!</h3>
        <ul>
          <li>
            React automatically escape
            <span class="fragment highlight-red">all</span>
            user input!
          </li>
          <li>The only framework without XSS mitigation bypasses<sup>1</sup></li>
        </ul>
        <footer>
          <small>
            <sup>1*</sup>
            <a href="https://github.com/google/security-research-pocs/blob/master/script-gadgets/bypasses.md">https://github.com/google/security-research-pocs/blob/master/script-gadgets/bypasses.md</a>
          </small>
        </footer>
      </section>
      <section>
        <h3>Why do mitigations exisits</h3>
        <p>Some frameworks and libraries has XSS vulnerability in their base.
          They are impossible to fix and instead are mitigated by workarounds.</p>
      </section>
      <section>
        <h3>Mitigation bypassess</h3>
        <p>Mitigations do not fix the vulnerability.
          They try to make the attacks harder instead.
          The XSS is still there, it’s just presumably
          harder to exploit it<sup>1</sup>.</p>
        <footer>
          <small>
            <sup>1</sup>
            <a href="https://www.owasp.org/images/3/32/OWASP_BeNeLux-Day_2017_Bypassing_XSS_mitigations_via_script_gadgets_Sebastian_Lekies.pdf">https://www.owasp.org/images/3/32/OWASP_BeNeLux-Day_2017_Bypassing_XSS_mitigations_via_script_gadgets_Sebastian_Lekies.pdf</a>
          </small>
        </footer>
      </section>
      <section>
        <h3>Examples of XSS out there</h3>
      </section>
      <section>
        <h4>Demo: simple text box</h4>
        <pre><code data-trim class="hljs">
          function SimpleTextInput() {
            const [text, setText] = React.useState('Welcome!');
      
            return (
              &lt;div&gt;
                  &lt;input
                    type="text"
                    onChange={e =&gt;
                      setText(e.target.value)
                    }
                  /&gt;
                  &lt;p&gt;{text}&lt;/p&gt;
                &lt;/div&gt;
            );
          }
        </code></pre>
      </section>
      <section>
        <h4>Demo: rich text box</h4>
        <pre><code data-trim class="hljs">
          function RichTextInput() {
            const [text, setText] = React.useState('Welcome!');
      
            return (
              &lt;div&gt;
                  &lt;input
                    type="text"
                    onChange={e =&gt;
                      setText(e.target.value)
                    }
                  /&gt;
                  &lt;p
                    dangerouslySetInnerHTML={
                      {__html: text}
                    }&gt;&lt;/p&gt;
                &lt;/div&gt;
            );
          }
        </code></pre>
      </section>
      <section>
        <h3>What would that do?</h3>
      </section>
      <section>
        <h3>Signal Desktop<sup>1</sup></h3>
        <div>
          <blockquote class="twitter-tweet"><p lang="en" dir="ltr">Remote zero-click JavaScript code execution on signal desktop message app. Thanks <a href="https://twitter.com/HacKanCuBa?ref_src=twsrc%5Etfw">@HacKanCuBa</a> and <a href="https://twitter.com/julianor?ref_src=twsrc%5Etfw">@julianor</a> <a href="https://t.co/YgT8akGfBI">pic.twitter.com/YgT8akGfBI</a></p>&mdash; Alfredo Ortega (@ortegaalfredo) <a href="https://twitter.com/ortegaalfredo/status/995017143002509313?ref_src=twsrc%5Etfw">May 11, 2018</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
        </div>
        <footer>
          <small><sup>1*</sup><a href="https://signal.org/">https://signal.org/</a></small>
        </footer>
      </section>
      <section>
        <h3>Signal Desktop</h3>
        <ul>
          <li><p>0-click XSS in quoted reply messages leading to Session Hijacking.</p></li>
          <li><p>In Electron application XSS becomes RCE.</p></li>
        </ul>
        <pre><code data-trim class="hljs">
          if (text) {
            return (
              &lt;div className="text" dangerouslySetInnerHTML={{ __html: text }} /&gt;
            );
          }
        </code></pre>
      </section>
      <section>
        <h4>Demo: links</h4>
        <pre><code data-trim class="hljs">
          function LinksTextInput() {
            const [links, setLinks] = React.useState([]);
      
            return (
              &lt;div&gt;
                &lt;input
                  type="text"
                  onKeyPress={e =&gt; {
                    if (e.key === 'Enter') {
                      setLinks(
                        [...links, e.target.value]
                      );
                    }
                  }}
                /&gt;
                &lt;ul&gt;
                  {links.map(link =&gt;
                      &lt;li&gt;&lt;a href={link}&gt;{link}&lt;/a&gt;&lt;/li&gt;
                  )}
                &lt;/ul&gt;
              &lt;/div&gt;
            );
          }
        </code></pre>
      </section>
      <section>
        <h3>What would that do?</h3>
      </section>
      <section>
        <h3>Lack of URL validation causes security issues in WhatsApp Web/Desktop</h3>
        <ul>
          <li><p>
            <sup>1</sup>
            1-Click stored XSS on WhatsApp Web leading to Session Hijacking</p>
          </li>
          <li><p>In Electron application XSS becomes RCE.</p></li>
        </ul>
        <footer>
          <small>
            <sup>1</sup>
            <a href="https://thehackernews.com/2020/02/hack-whatsapp-web.html">https://thehackernews.com/2020/02/hack-whatsapp-web.html</a>
          </small>
        </footer>
      </section>
      <section>
        <h4>Demo: link reconstruction</h4>
        <pre><code data-trim class="hljs">
          function ParsedLinksTextInput() {
            const [links, setLinks] = React.useState([]);
      
            return (
              ...
                &lt;ul&gt;
                  {links.map(link =&gt;
                      &lt;li&gt;&lt;a href={`https://${link.domain}{link.path}`}&gt;
                        {`https//${link.domain}{link.path}`}
                      &lt;/a&gt;&lt;/li&gt;
                  )}
                &lt;/ul&gt;
              ...
            );
          }
        </code></pre>
      </section>
      <section>
        <h3>What would that do?</h3>
      </section>
      <section>
        <h3>Incorrect url reconstruction causes security issues in WhatsApp Web/Desktop</h3>
        <ul>
          <li><p>
            1-Click stored XSS on WhatsApp Web leading to Session Hijacking</p>
          </li>
        </ul>
      </section>
      <section>
        <h3>XSS to Electron RCE</h3>
        <ul>
          <li><p>
            <sup>1</sup>
            <code class="inline-code">nodeIntegration</code> when ON exposes Node.js APIs & modules to renderer
          </p></li>
          <li><p>
            <sup>2</sup>
            <code class="inline-code">contextIsolation</code> when OFF allows preload script and renderer in the same JavaScript context
            <p>Allows prototype pollution attacks</p>
          </p></li>
        </ul>
        <footer>
          <small>
            <sup>1</sup>
            <a href="https://github.com/electron/electron/blob/master/docs/tutorial/security.md#2-do-not-enable-nodejs-integration-for-remote-content">https://github.com/electron/electron/blob/master/docs/tutorial/security.md#2-do-not-enable-nodejs-integration-for-remote-content </a>
          </small>
          <small>
            <sup>2</sup>
            <a href="https://github.com/electron/electron/blob/master/docs/tutorial/security.md#3-enable-context-isolation-for-remote-content">https://github.com/electron/electron/blob/master/docs/tutorial/security.md#3-enable-context-isolation-for-remote-content</a>
          </small>
        </footer>
      </section>
      <section>
        <h3>Demo: Node Integration</h3>
        <pre><code data-trim class="hljs">
          require('child_process').execSync('/Applications/Calculator.app');
        </code></pre>
        <pre><code data-trim class="hljs">
          // Require is removed but process is exposed.
          process.mainModule.require('child_process').execSync('/Applications/Calculator.app');
        </code></pre>
      </section>
      <section>
        <h3>Demo: Context Isolation</h3>
        <pre><code data-trim class="hljs">
          let emit = this.Native.ipcRenderer.__proto__.emit;
          this.Native.ipcRenderer.__proto__.emit = function(...args) {
              emit.apply(this, args);
              if (args[0].startsWith('ELECTRON_')) {
                  console.error(args);
                  // In ElectronInternal.IpcMainInternal, Jackpot!
                  let res = this.sendSync("ELECTRON_BROWSER_REQUIRE", 4, "child_process");
                  res = this.sendSync("ELECTRON_BROWSER_MEMBER_CALL", 5, res.id, "exec", [{
                      type: "value",
                      value: "open /Applications/Calculator.app"
                  }])
              }
          };
        </code></pre>
      </section>
      <section>
        <h3>Remediation</h3>
      </section>
      <section>
        <h3>Links Sanitization</h3>
        <pre><code data-trim class="hljs">
          const userSuppliedURL = e.target.value;
          // path here starts with '/'
          const parsed = new URL(userSuppliedURL);
          // whitelist protocols
          if (parsed.protocol !== "https:") {
            return; // Bad Link!
          }
        </code></pre>
      </section>
      <section>
        <h2>Content Security Policy (CSP)</h2>
        <footer>
          <small>
            <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP">https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP</a></small>
        </footer>
      </section>
      <section>
        <h3>CSP</h3>
        <p>Let the browser enforce:</p>
        <ul>
          <li><p>
            Where content can be loaded from (e.g. scripts, fonts, images, media, etc.)
          </p></li>
          <li><p>
            Prevent (malicious) script execution
            <ul>
              <li><p>
                Disables inline <code class="inline-code">&lt;script&gt;</code> elems by default, prevents <code class="inline-code">eval()</code> in JS
              </p></li>
              <li><p>
                hash / nonce based authentication for trusted scripts
              </p></li>
            </ul>
          </p></li>
          <li><p>
            Only allow HTTPS connections
          </p></li>
        </ul>
      </section>
      <section>
        <h3>Define CSP</h3>
        <p>as an http response headers</p>
        <pre><code data-trim>
          Content-Security-Policy: policy
        </code></pre>
        <p>as a meta tag</p>
        <pre><code data-trim>
          &lt;meta http-equiv="Content-Security-Policy" content="policy" &gt;
        </code></pre>
      </section>
      <section>
        <h3>CSP: Script Src</h3>
        <pre><code data-trim class="hljs">
          Content-Security-Policy: script-src https://example.com/;
        </code></pre>
        <pre><code data-trim class="hljs">
          &lt;script src="https://non-example.com/js/library.js" /&gt; // Error!
        </code></pre>
        <img src="./img/csp-error.png" alt="">
        <pre><code data-trim class="hljs">
          &lt;script src="https://example.com/js/library.js" /&gt; // Ok
        </code></pre>
      </section>
      <section>
        <h3>CSP: Script Nonce</h3>
        <pre><code>
          &lt;script src="..." nonce="nоnce-${hash}" /&gt;
        </code></pre>
        <pre><code data-trim class="hljs">
          Content-Security-Policy: script-src nоnce-${hash};
        </code></pre>
      </section>
      <section>
        <h3>CSP: Script Src Report Only</h3>
        <pre><code data-trim class="hljs">
          Content-Security-Policy-Report-Only: script-src https://example.com/
            report-uri https://www.facebook.com/csp/reporting/;
        </code></pre>
        <pre><code data-trim class="hljs">
          /&lt;script src="https://non-example.com.com/js/library.js" /&gt // Report error!
        </code></pre>
        <img src="./img/csp-report.png" width="800" alt="">
        <pre><code data-trim class="hljs">
          /&lt;script src="https://example.com/js/library.js" /&gt // Ok
        </code></pre>
      </section>
      <section>
        <h3>CSP: Script Webpack config</h3>
        <pre><code data-trim class="hljs">
          new ScriptExtHtmlWebpackPlugin({
            custom: [{
                    test: /\.js$/,
                    attribute: 'nonce',
                    value: 'nonce-' + sha256Str
            }]
          }),
          new CspHtmlWebpackPlugin({
              'base-uri': '\'self\'',
              'object-src': '\'none\'',
              'script-src': ['\'self\'', '\'unsafe-eval\'', '\'nonce-' + sha256Str + '\''],
              'style-src': ['\'unsafe-inline\'', '\'self\'']
            }, {
              devAllowUnsafe: false,
              enabled: true,
              hashingMethod: 'sha256'
          }),
        </code></pre>
      </section>
      <section>
        <h3>CSP: Trusted Types</h3>
        <pre><code data-trim class="hljs">
          Content-Security-Policy: trusted-types *;
        </code></pre>
        <pre><code data-trim class="hljs">
          element.innerHTML = 'A String'; // TypeError!
        </code></pre>
        <img src="./img/tterror.png" alt="">
        <pre><code data-trim class="hljs">
          element.innerHTML = trustedType; // Ok
        </code></pre>
      </section>
      <section>
        <h3>CSP: Trusted Types Create Policy</h3>
        <pre><code data-trim class="hljs">
          const sanitizingPolicy = TrustedTypes.createPolicy('sanitize-html', {
            createHTML: (input) => Sanitizer(input),
          });
        </code></pre>
        <pre><code data-trim class="hljs">
          // sanitizingPolicy.createHTML returns a typed TrustedHTML object
          element.innerHTML = sanitizingPolicy.createHTML(untrustedValue);
        </code></pre>
      </section>
      <section>
        <h3>npm audit</h3>
        <ul>
          <li><p>We live in world of NPM where 99% of your application is dependencies</p></li>
          <li><p><code class="inline-code">npm audit</code> or <code class="inline-code">yarn audit</code> shows existing security issues and severity in dependencies</p></li>
        </ul>
      </section>
      <section>
        <h3>Remediation</h3>
        <ul>
          <li>Security Teams</li>
          <li>External services like WhiteHatSec<sup>1</sup></li>
          <li>Use your knowledge</li>
        </ul>
        <footer>
          <p>
            <sup>1</sup>
            <a href="https://www.whitehatsec.com/">https://www.whitehatsec.com/</a>
          </p>
        </footer>
      </section>
      <section>
        <h3>Remediation</h3>
        <ul>
          <li><p>Never use <code class="inline-code">dangerouslySetInnerHTML</code> with user-supplied input</p></li>
          <li><p>This includes using <code class="inline-code">document.createElement</code> and <code class="inline-code"></code>elem.innerHtml</code> in util scripts!</p></li>
          <li><p>Use iFrame sandboxing when sanitizing user provided input (or better yet, don't touch the DOM!)</p></li>
          <li><p>Leverage whitelisting to prevent unsafe URI schemes (and external hostnames)</p></li>
          <li><p>Re-use existing components instead of <code class="inline-code">HTMLAnchorElement</code></p></li>
          <li><p>Make generous use of <code class="inline-code">npm audit</code> for dependencies and keep your dependencies up to date</p></li>
          <li><p>Lint rules to detect use of dangerous functions and bad coding patterns</p></li>
          <li><p>Be excited and ready to adopt new security features</p></li>
        </ul>
      </section>
      <section>
        <h2>Thank you for listening!</h2>
        <h3>Please, ask questions!</h3>
      </section>
      <section>
        <h3>To read more</h3>
        <ul>
          <li><small>
            <a href="http://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=WhatsApp">
              Common Vulnerabilities and Exposures
            </a>
            <br />
            by U.S. Department of Homeland Security
          </small></li>
          <li><small>
            <a href="https://habr.com/ru/post/445932/">
              Безопасность клиентских приложений: практические советы для Front-end разработчика
            </a>
            <br/>
            by Alexander Rudenko
          </small></li>
          <li><small>
            <a href="https://www.linkedin.com/pulse/even-faster-single-page-application-9security-sergei-iastrebov/">
              Even Faster Single Page Application: 9.Security
            </a>
            <br/>
            by Sergei Iastrebov
            </small>
          </small></li>
        </ul>
      </section>
      <section>
        <h3>WhatsApp perspective</h3>
        <p>Traditionally user generated content has quite a few stops before it reaches other participants.</p>
        <img src="./img/way-bw.png" height="400" class="icon" alt="Message way">
      </section>
      <section>
        <h3>WhatsApp perspective</h3>
        <p>In WhatsApp world user generated content has only 2 stops.</p>
        <img src="./img/alice-bob-inv.png" height="400" class="icon" alt="Alice and Bob">
      </section>
    </div>
  </div>

  <script src="reveal.js/js/reveal.js"></script>

  <script>
    Reveal.initialize({
      dependencies: [
        // Interpret Markdown in <section> elements
        { src: 'reveal.js/plugin/markdown/marked.js', condition: function () { return !!document.querySelector('[data-markdown]'); } },
        { src: 'reveal.js/plugin/markdown/markdown.js', condition: function () { return !!document.querySelector('[data-markdown]'); } },

        // Syntax highlight for <code> elements
        { src: 'reveal.js/plugin/highlight/highlight.js', async: true },

        // Zoom in and out with Alt+click
        { src: 'reveal.js/plugin/zoom-js/zoom.js', async: true },

        // Speaker notes
        { src: 'reveal.js/plugin/notes/notes.js', async: true },

        // MathJax
        { src: 'reveal.js/plugin/math/math.js', async: true }
      ]
    });
  </script>
</body>

</html>
